{% extends 'base.html' %}

{% block title %}Location Sharing & SOS - Nomado{% endblock %}

{% block content %}
<div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 2rem 0; margin-bottom: 2rem;">
    <div style="max-width: 1200px; margin: 0 auto; padding: 0 20px;">
        <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">Safety & Location Sharing</h1>
        <p style="font-size: 1.2rem; opacity: 0.9;">Stay connected and safe during your travels</p>
    </div>
</div>

<div class="container" style="max-width: 1000px; margin: 0 auto; padding: 0 1rem;">
    <!-- Location Status Card -->
    <div class="card" style="margin-bottom: 2rem; border-left: 4px solid #e74c3c;">
        <div style="display: flex; align-items: center; justify-content: between; margin-bottom: 1rem;">
            <h3 style="color: #e74c3c; margin: 0;">Current Location Status</h3>
            <span id="locationStatus" style="padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: bold; background: #f8f9fa; color: #6c757d;">
                Location Not Shared
            </span>
        </div>
        
        <div id="locationInfo" style="display: none; background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                <div>
                    <strong>Latitude:</strong> <span id="currentLat">-</span><br>
                    <strong>Longitude:</strong> <span id="currentLng">-</span>
                </div>
                <div>
                    <strong>Last Updated:</strong> <span id="lastUpdate">-</span><br>
                    <strong>Accuracy:</strong> <span id="accuracy">-</span>
                </div>
            </div>
            <div style="margin-top: 1rem;">
                <strong>Address:</strong> <span id="currentAddress">Getting address...</span>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
        <!-- Share Location Card -->
        <div class="card" style="text-align: center; border-left: 4px solid #28a745;">
            <div style="font-size: 3rem; margin-bottom: 1rem; color: #28a745;">üìç</div>
            <h4 style="color: #28a745; margin-bottom: 1rem;">Share My Location</h4>
            <p style="color: #666; margin-bottom: 1.5rem;">Share your current location with trusted contacts for safety</p>
            
            <button id="shareLocationBtn" class="btn" style="background: #28a745; border: none; width: 100%; margin-bottom: 1rem;">
                <span id="shareButtonText">Start Sharing Location</span>
                <div id="shareButtonSpinner" style="display: none; margin-left: 0.5rem;">
                    <div style="width: 16px; height: 16px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                </div>
            </button>
            
            <small style="color: #666;">Location updates every 30 seconds when active</small>
        </div>

        <!-- SOS Alert Card -->
        <div class="card" style="text-align: center; border-left: 4px solid #dc3545;">
            <div style="font-size: 3rem; margin-bottom: 1rem; color: #dc3545;">üÜò</div>
            <h4 style="color: #dc3545; margin-bottom: 1rem;">Emergency SOS Alert</h4>
            <p style="color: #666; margin-bottom: 1.5rem;">Send immediate alert with your location to emergency contacts</p>
            
            <button id="sosAlertBtn" class="btn" style="background: #dc3545; border: none; width: 100%; margin-bottom: 1rem;">
                Send SOS Alert
            </button>
            
            <small style="color: #666;">For emergencies only - alerts all registered contacts</small>
        </div>
    </div>

    <!-- Emergency Contacts Section -->
    <div class="card" style="margin-bottom: 2rem;">
        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="color: #667eea; margin: 0;">Emergency Contacts ({{ contacts.count }})</h3>
            <a href="{% url 'emergency_contacts' %}" class="btn btn-secondary" style="padding: 0.5rem 1rem;">
                Manage Contacts
            </a>
        </div>
        
        <div id="contactsList">
            {% if contacts %}
                {% for contact in contacts %}
                <div class="contact-item">
                    <div>
                        <strong>{{ contact.name }}</strong> <span style="color: #666;">({{ contact.get_relationship_display }})</span><br>
                        <small style="color: #666;">‚úâÔ∏è {{ contact.email }}</small>
                        {% if contact.is_primary %}
                            <span style="background: #27ae60; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 10px;">Primary</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; color: #666; padding: 2rem;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">üë•</div>
                    <p>No emergency contacts added yet</p>
                    <small>Add contacts who should receive your location and emergency alerts</small>
                    <br><br>
                    <a href="{% url 'emergency_contacts' %}" class="btn">Add Emergency Contact</a>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Recent Location Shares -->
    {% if active_shares %}
    <div class="card" style="margin-bottom: 2rem;">
        <h3 style="color: #667eea; margin-bottom: 1.5rem;">Active Location Shares</h3>
        <div>
            {% for share in active_shares %}
            <div style="padding: 1rem; border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 1rem; background: #f8f9fa;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>Location Share Active</strong><br>
                        <small style="color: #666;">
                            Started: {{ share.created_at|date:"M d, Y H:i" }} | 
                            Expires: {{ share.expires_at|date:"M d, Y H:i" }}
                        </small>
                        {% if share.message %}
                        <br><small style="color: #666;">Message: {{ share.message }}</small>
                        {% endif %}
                    </div>
                    <div>
                        <a href="{{ share.share_url }}" target="_blank" class="btn btn-secondary" style="padding: 0.5rem 1rem;">View Share</a>
                        <form method="post" action="{% url 'stop_location_share' share.share_id %}" style="display: inline; margin-left: 5px;">
                            {% csrf_token %}
                            <button type="submit" class="btn" style="background: #dc3545; padding: 0.5rem 1rem; font-size: 0.9rem;">Stop</button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Safety Tips -->
    <div class="card" style="background: #f8f9fa;">
        <h3 style="color: #667eea; margin-bottom: 1.5rem;">Safety Tips</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
            <div>
                <h5 style="color: #28a745;">Location Sharing</h5>
                <ul style="color: #666; line-height: 1.6;">
                    <li>Share location when traveling to new places</li>
                    <li>Keep location sharing active during solo trips</li>
                    <li>Update emergency contacts regularly</li>
                    <li>Inform contacts about your travel plans</li>
                </ul>
            </div>
            <div>
                <h5 style="color: #dc3545;">Emergency SOS</h5>
                <ul style="color: #666; line-height: 1.6;">
                    <li>Use SOS only in genuine emergencies</li>
                    <li>Ensure emergency contacts are reliable</li>
                    <li>Keep your phone charged when traveling</li>
                    <li>Know local emergency numbers</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- SOS Confirmation Modal -->
<div id="sosModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1001;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 10px; width: 90%; max-width: 400px; text-align: center;">
        <div style="font-size: 4rem; color: #dc3545; margin-bottom: 1rem;">üÜò</div>
        <h3 style="color: #dc3545; margin-bottom: 1rem;">Send SOS Alert?</h3>
        <p style="margin-bottom: 2rem;">This will immediately send your current location to all {{ contacts.count }} emergency contact{{ contacts.count|pluralize }} with an SOS message.</p>
        <div style="display: flex; gap: 1rem;">
            <button id="confirmSosBtn" class="btn" style="background: #dc3545; border: none; flex: 1;">Send SOS Alert</button>
            <button id="cancelSosBtn" class="btn btn-secondary" style="flex: 1;">Cancel</button>
        </div>
    </div>
</div>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.contact-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 1rem;
}

.contact-item:hover {
    background: #f8f9fa;
}
</style>

<script>
let watchId = null;
let isSharing = false;
let userLocation = null;

// Emergency contacts count from Django
const emergencyContactsCount = {{ contacts.count|default:0 }};

document.addEventListener('DOMContentLoaded', function() {
    // Check if already sharing (you can implement this with Django session if needed)
    // For now, just initialize the interface
});

// Location Sharing Functions
document.getElementById('shareLocationBtn').addEventListener('click', function() {
    if (isSharing) {
        stopLocationSharing();
    } else {
        startLocationSharing();
    }
});

function startLocationSharing() {
    if (!navigator.geolocation) {
        alert('Geolocation is not supported by this browser.');
        return;
    }
    
    const button = document.getElementById('shareLocationBtn');
    const buttonText = document.getElementById('shareButtonText');
    const buttonSpinner = document.getElementById('shareButtonSpinner');
    
    buttonText.textContent = 'Getting Location...';
    buttonSpinner.style.display = 'inline-block';
    
    const options = {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 30000
    };
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            userLocation = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy
            };
            
            // Send location share request to Django backend
            shareLocationWithServer();
            
            // Update UI
            isSharing = true;
            buttonText.textContent = 'Stop Sharing Location';
            buttonSpinner.style.display = 'none';
            button.style.background = '#dc3545';
            document.getElementById('locationStatus').textContent = 'Location Being Shared';
            document.getElementById('locationStatus').style.background = '#d4edda';
            document.getElementById('locationStatus').style.color = '#155724';
            
            // Update location display
            updateLocationDisplay(position);
        },
        function(error) {
            handleLocationError(error);
            buttonText.textContent = 'Start Sharing Location';
            buttonSpinner.style.display = 'none';
        },
        options
    );
}

function shareLocationWithServer() {
    if (!userLocation) return;
    
    const duration_hours = 1; // Default to 1 hour
    const message = "Live location sharing activated";
    
    fetch('{% url "share_location_ajax" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            latitude: userLocation.latitude,
            longitude: userLocation.longitude,
            address: document.getElementById('currentAddress').textContent || '',
            message: message,
            duration_hours: duration_hours,
            selected_contacts: [] // Will use all emergency contacts
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Location sharing started successfully');
            // Don't reload the page - just show success message
            alert(`Location sharing started!`);
        } else {
            alert('Error starting location sharing: ' + data.message);
            // Reset button state on error
            stopLocationSharing();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error starting location sharing');
        // Reset button state on error
        stopLocationSharing();
    });
}

function stopLocationSharing() {
    // Stop any active location shares on server
    fetch('/safety/ajax/stop-all-shares/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Location sharing stopped on server');
    })
    .catch(error => {
        console.error('Error stopping server shares:', error);
    });
    
    isSharing = false;
    
    const button = document.getElementById('shareLocationBtn');
    const buttonText = document.getElementById('shareButtonText');
    
    buttonText.textContent = 'Start Sharing Location';
    button.style.background = '#28a745';
    document.getElementById('locationStatus').textContent = 'Location Not Shared';
    document.getElementById('locationStatus').style.background = '#f8f9fa';
    document.getElementById('locationStatus').style.color = '#6c757d';
}

function updateLocationDisplay(position) {
    const lat = position.coords.latitude;
    const lng = position.coords.longitude;
    const accuracy = position.coords.accuracy;
    
    document.getElementById('currentLat').textContent = lat.toFixed(6);
    document.getElementById('currentLng').textContent = lng.toFixed(6);
    document.getElementById('accuracy').textContent = accuracy.toFixed(0) + ' meters';
    document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
    document.getElementById('locationInfo').style.display = 'block';
    
    // Get address from coordinates
    getAddressFromCoords(lat, lng);
}

function getAddressFromCoords(lat, lng) {
    // Simple fallback - you can implement proper reverse geocoding
    document.getElementById('currentAddress').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
}

function handleLocationError(error) {
    let message = '';
    switch(error.code) {
        case error.PERMISSION_DENIED:
            message = "Location access denied by user.";
            break;
        case error.POSITION_UNAVAILABLE:
            message = "Location information is unavailable.";
            break;
        case error.TIMEOUT:
            message = "Location request timed out.";
            break;
        default:
            message = "An unknown error occurred.";
            break;
    }
    alert(message);
}

// SOS Alert Functions
document.getElementById('sosAlertBtn').addEventListener('click', function() {
    if (emergencyContactsCount === 0) {
        alert('Please add emergency contacts first before sending SOS alerts.');
        return;
    }
    document.getElementById('sosModal').style.display = 'block';
});

document.getElementById('confirmSosBtn').addEventListener('click', function() {
    sendSOSAlert();
    document.getElementById('sosModal').style.display = 'none';
});

document.getElementById('cancelSosBtn').addEventListener('click', function() {
    document.getElementById('sosModal').style.display = 'none';
});

function sendSOSAlert() {
    if (!navigator.geolocation) {
        alert('Geolocation is not supported by this browser.');
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // Send SOS alert to Django backend
            fetch('{% url "trigger_sos_ajax" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    latitude: lat,
                    longitude: lng,
                    address: document.getElementById('currentAddress').textContent || '',
                    alert_type: 'EMERGENCY',
                    message: 'Emergency SOS triggered from location sharing page'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`SOS alert sent successfully! ${data.emails_sent} emergency contacts notified via email.`);
                } else {
                    alert('Error sending SOS alert: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error sending SOS alert');
            });
        },
        function(error) {
            handleLocationError(error);
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Close modal when clicking outside
window.onclick = function(event) {
    const sosModal = document.getElementById('sosModal');
    if (event.target === sosModal) {
        sosModal.style.display = 'none';
    }
}
</script>
{% endblock %}