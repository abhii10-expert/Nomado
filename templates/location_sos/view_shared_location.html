<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if not_found %}Location Not Found{% elif expired %}Location Share Expired{% else %}Live Location - {{ user_name }}{% endif %} - Nomado</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .info-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .location-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        .info-label {
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px;
        }
        .info-value {
            font-size: 16px;
            color: #34495e;
            margin-top: 5px;
        }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 10px;
            border: 2px solid #3498db;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin: 10px 5px;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        .error-message {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        .error-message h2 {
            color: #e74c3c;
            margin-bottom: 20px;
        }
        .refresh-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #856404;
        }
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .location-info {
                grid-template-columns: 1fr;
            }
            #map {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        {% if not_found %}
        <!-- Location Not Found -->
        <div class="error-message">
            <h2>Location Share Not Found</h2>
            <p>The location sharing link you're looking for doesn't exist or has been removed.</p>
            <p>Please check the link and try again.</p>
        </div>
        
        {% elif expired %}
        <!-- Location Share Expired -->
        <div class="header">
            <h1>Location Share Expired</h1>
            <p>{{ user_name }}'s location sharing has expired</p>
        </div>
        
        <div class="info-panel">
            <div style="text-align: center; padding: 30px;">
                <div style="font-size: 4rem; margin-bottom: 20px;">âŒ›</div>
                <h3>This location share has expired</h3>
                <p style="color: #666;">{{ user_name }} was sharing their location with you, but the sharing period has ended.</p>
                <p style="color: #666;">If you need to track their current location, please contact them directly.</p>
            </div>
        </div>
        
        {% else %}
        <!-- Active Location Sharing -->
        <div class="header">
            <h1>Live Location Tracking</h1>
            <p>{{ user_name }} is sharing their location with you</p>
            <span class="status-badge status-active">LIVE</span>
        </div>

        {% if location_share.message %}
        <div class="info-panel">
            <h3>Message from {{ user_name }}</h3>
            <p style="font-style: italic; color: #666;">"{{ location_share.message }}"</p>
        </div>
        {% endif %}

        <div class="refresh-info">
            <strong>Auto-Refresh:</strong> This page automatically updates every 30 seconds. 
            Last updated: <span id="lastUpdateTime">{{ location_share.last_updated|date:"H:i:s" }}</span>
        </div>

        <div class="info-panel">
            <div class="location-info">
                <div class="info-card">
                    <div class="info-label">Current Location</div>
                    <div class="info-value" id="coordinates">
                        {{ location_share.latitude }}, {{ location_share.longitude }}
                    </div>
                </div>
                
                <div class="info-card">
                    <div class="info-label">Address</div>
                    <div class="info-value" id="address">
                        {% if location_share.address %}{{ location_share.address }}{% else %}Address not available{% endif %}
                    </div>
                </div>
                
                <div class="info-card">
                    <div class="info-label">Shared Since</div>
                    <div class="info-value">
                        {{ location_share.created_at|date:"M d, Y H:i" }}
                    </div>
                </div>
                
                <div class="info-card">
                    <div class="info-label">Expires At</div>
                    <div class="info-value" style="color: #e74c3c;">
                        {{ location_share.expires_at|date:"M d, Y H:i" }}
                        <br><small>(<span id="timeRemaining">{{ time_remaining|floatformat:1 }} hours remaining</span>)</small>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="refreshPage()" class="btn">Refresh Location</button>
                <a href="https://maps.google.com/?q={{ location_share.latitude }},{{ location_share.longitude }}" target="_blank" class="btn btn-success">
                    Open in Google Maps
                </a>
                <a href="https://www.google.com/maps/dir/?api=1&destination={{ location_share.latitude }},{{ location_share.longitude }}" target="_blank" class="btn">
                    Get Directions
                </a>
            </div>
        </div>

        <!-- Simple Map Container (Fallback) -->
        <div class="info-panel">
            <h3>Location Map</h3>
            <div id="map">
                <div>
                    <p>{{ user_name }}'s Location</p>
                    <p><strong>{{ location_share.latitude }}, {{ location_share.longitude }}</strong></p>
                    <a href="https://maps.google.com/?q={{ location_share.latitude }},{{ location_share.longitude }}" target="_blank" class="btn">
                        View Full Map
                    </a>
                </div>
            </div>
            <div style="margin-top: 10px; font-size: 12px; color: #666; text-align: center;">
                Click "View Full Map" or "Open in Google Maps" to see the interactive map
            </div>
        </div>
        
        {% endif %}
    </div>

    <!-- Store Django data in hidden elements for JavaScript -->
    {% if not expired and not not_found %}
    <div id="location-data" style="display: none;"
         data-lat="{{ location_share.latitude }}"
         data-lng="{{ location_share.longitude }}"
         data-user-name="{{ user_name }}"
         data-share-id="{{ location_share.share_id }}"
         data-expires-at="{{ location_share.expires_at|date:'c' }}">
    </div>
    {% endif %}

    <script>
        // Get location data from DOM instead of Django template variables
        function getLocationData() {
            var dataEl = document.getElementById('location-data');
            if (!dataEl) return null;
            
            return {
                lat: parseFloat(dataEl.getAttribute('data-lat')),
                lng: parseFloat(dataEl.getAttribute('data-lng')),
                userName: dataEl.getAttribute('data-user-name'),
                shareId: dataEl.getAttribute('data-share-id'),
                expiresAt: new Date(dataEl.getAttribute('data-expires-at'))
            };
        }

        // Simple page refresh function
        function refreshPage() {
            document.getElementById('lastUpdateTime').textContent = new Date().toLocaleTimeString();
            // Reload the page to get fresh data
            setTimeout(function() {
                window.location.reload();
            }, 500);
        }

        // Auto-refresh every 30 seconds
        setInterval(function() {
            refreshPage();
        }, 30000);

        // Update time remaining every minute
        setInterval(function() {
            var locationData = getLocationData();
            if (!locationData) return;
            
            var now = new Date();
            var expiresAt = locationData.expiresAt;
            var timeDiff = expiresAt - now;
            
            var timeRemainingEl = document.getElementById('timeRemaining');
            if (!timeRemainingEl) return;
            
            if (timeDiff <= 0) {
                timeRemainingEl.textContent = 'Expired';
                timeRemainingEl.style.color = '#e74c3c';
                // Reload page to show expired state
                setTimeout(function() {
                    window.location.reload();
                }, 2000);
            } else {
                var hours = Math.floor(timeDiff / (1000 * 60 * 60));
                var minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                timeRemainingEl.textContent = hours + 'h ' + minutes + 'm remaining';
            }
        }, 60000);

        // Simple error handling
        window.addEventListener('error', function(e) {
            console.log('Page error:', e.message);
        });

        // Show page load success
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Location tracking page loaded successfully');
        });
    </script>
</body>
</html>